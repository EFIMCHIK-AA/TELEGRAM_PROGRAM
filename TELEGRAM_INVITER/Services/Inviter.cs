using CefSharp;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using TELEGRAM_INVITER.Exceptions;

namespace TELEGRAM_INVITER.Services
{
    public class Inviter
    {
        public static Boolean IsWork = false;

        private void StopWork()
        {
            if(!IsWork)
            {
                throw new StopWorkException("Работа прервана пользователем");
            }
        }

        private String GetScript(String nameUser)
        {
            return @"function Delay(ms){return new Promise((function(resolve,reject){setTimeout(resolve,ms)}))}async function InviteUser(nameUser){if(IsEmpty(nameUser))return'Пустое имя пользователя';var resultChannelDiv=null,resultButtonInvite=null,resultChannelButton=null,resultContactslDiv=GetContactslDiv();return null!=resultContactslDiv?await SetUser(nameUser,resultContactslDiv):null!=(resultChannelDiv=GetChannelDiv())?null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)):null==(resultChannelButton=ClickOnChannelButton())?'Ошибка при поиске кнопки чата':(await Delay(300),null==(resultChannelDiv=GetChannelDiv())?'Ошибка при поиске контейнера чата':null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)))}async function SetUser(nameUser,resultContactslDiv){var resultSearchInput=GetSearchInput(resultContactslDiv),resultClickSelectedUser;if(null==resultSearchInput)return'Ошибка при поиске контейнера поиска';resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change'));for(var i=0;i<nameUser.length;i++)resultSearchInput.value=resultSearchInput.value+nameUser[i],resultSearchInput.dispatchEvent(new Event('change')),await Delay(250);for(var count=0;;){var resultButtonClickUser=ClickOnButtonUser(resultContactslDiv,nameUser);if(5==count||null!=resultButtonClickUser)break;null==resultButtonClickUser&&(count+=1,await Delay(1e3))}return null==resultButtonClickUser?(resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),'Пользователь не найден'):(await Delay(300),null==GetButtonSelectedUser(resultContactslDiv)?'Кнопка подтверждения инвайта не найдена':'Пользователь успешно добавлен')}function ClickOnButtonInvite(){var buttonInvite=GetElementByTagAndAttributeFromDocument('ng-click','a','inviteToChannel()');return null!=buttonInvite?(buttonInvite.click(),buttonInvite):null}function GetChannelDiv(){var channelDiv=GetElementByTagAndClassFromDocument('div','chat_modal_wrap md_modal_wrap');return null!=channelDiv?channelDiv:null}function GetContactslDiv(){var сontactslDiv=GetElementByTagAndClassFromDocument('div','contacts_modal_wrap md_modal_wrap');return null!=сontactslDiv?сontactslDiv:null}function ClickOnButtonUser(element,userName){var buttonUser=ClickOnUserContainerFromElement('ng-click','a','contacts_modal_contact','contactSelect(contact.userID)',element,'span',userName);return null!=buttonUser?(buttonUser.click(),buttonUser):null}function GetSearchInput(element){var сontactslDiv=GetElementByTagAndAttributeFromElement('ng-model','input','search.query','search',element);return null!=сontactslDiv?сontactslDiv:null}function GetButtonSelectedUser(element){var selectButton=GetElementByTagAndAttributeFromElement('ng-click','button','submitSelected()','submit',element);return null!=selectButton?(selectButton.click(),selectButton):null}function ClickOnChannelButton(){var buttonChannel=GetElementByTagAndAttributeFromDocument('ng-click','a','showPeerInfo()');return null!=buttonChannel?(buttonChannel.click(),buttonChannel):null}function GetElementByTagAndAttributeFromDocument(attribute,tag,attributeVal){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;for(var matchingElements=[],allElements=document.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndClassFromDocument(tag,classValue){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;for(var matchingElements=[],allElements=document.getElementsByClassName(classValue),i=0;i<allElements.length;i++){var tagUpper=tag.toUpperCase();if(allElements[i].tagName==tagUpper){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function ClickOnUserContainerFromElement(attribute,tag,classValue,attributeVal,element,tag2,username){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;if(IsEmpty(attribute))return null;if(IsEmpty(attributeVal))return null;if(null==element)return null;if(IsEmpty(tag2))return null;if(IsEmpty(username))return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){if(allElements[i].className==classValue&&allElements[i].getAttribute(attribute)==attributeVal)for(var allElementsSpan=allElements[i].getElementsByTagName(tag2),j=0;j<allElementsSpan.length;j++)if(allElementsSpan[j].innerText==username){matchingElements.push(allElements[i]);break}if(matchingElements.length>0)break}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndAttributeFromElement(attribute,tag,attributeVal,type,element){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;if(IsEmpty(type))return null;if(null==element)return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal&&allElements[i].type==type){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function IsEmpty(str){return!str||0===str.length}InviteUser('" + nameUser + "');";
            //return @"function Delay(ms){return new Promise((function(resolve,reject){setTimeout(resolve,ms)}))}async function InviteUser(nameUser){if(IsEmpty(nameUser))return'Пустое имя пользователя';var resultChannelDiv=null,resultButtonInvite=null,resultChannelButton=null,resultContactslDiv=GetContactslDiv();return null!=resultContactslDiv?await SetUser(nameUser,resultContactslDiv):null!=(resultChannelDiv=GetChannelDiv())?null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)):null==(resultChannelButton=ClickOnChannelButton())?'Ошибка при поиске кнопки чата':(await Delay(300),null==(resultChannelDiv=GetChannelDiv())?'Ошибка при поиске контейнера чата':null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)))}async function SetUser(nameUser,resultContactslDiv){var resultSearchInput=GetSearchInput(resultContactslDiv);if(null==resultSearchInput)return'Ошибка при поиске контейнера поиска';for(var i=0;i<nameUser.length;i++)resultSearchInput.value=resultSearchInput.value+nameUser[i],resultSearchInput.dispatchEvent(new Event('change')),await Delay(250);for(var count=0;;){var resultButtonClickUser=ClickOnButtonUser(resultContactslDiv,nameUser);if(10==count||null!=resultButtonClickUser)break;null==resultButtonClickUser&&(count+=1,await Delay(1e3))}if(null==resultButtonClickUser)return resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),'Пользователь не найден';await Delay(300);var resultClickSelectedUser=GetButtonSelectedUser(resultContactslDiv);return resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),null==resultClickSelectedUser?'Кнопка подтверждения инвайта не найдена':'Пользователь успешно добавлен'}function ClickOnButtonInvite(){var buttonInvite=GetElementByTagAndAttributeFromDocument('ng-click','a','inviteToChannel()');return null!=buttonInvite?(buttonInvite.click(),buttonInvite):null}function GetChannelDiv(){var channelDiv=GetElementByTagAndClassFromDocument('div','chat_modal_wrap md_modal_wrap');return null!=channelDiv?channelDiv:null}function GetContactslDiv(){var сontactslDiv=GetElementByTagAndClassFromDocument('div','contacts_modal_wrap md_modal_wrap');return null!=сontactslDiv?сontactslDiv:null}function ClickOnButtonUser(element,userName){var buttonUser=ClickOnUserContainerFromElement('ng-click','a','contacts_modal_contact','contactSelect(contact.userID)',element,'span',userName);return null!=buttonUser?(buttonUser.click(),buttonUser):null}function GetSearchInput(element){var сontactslDiv=GetElementByTagAndAttributeFromElement('ng-model','input','search.query','search',element);return null!=сontactslDiv?сontactslDiv:null}function GetButtonSelectedUser(element){var selectButton=GetElementByTagAndAttributeFromElement('ng-click','button','submitSelected()','submit',element);return null!=selectButton?(selectButton.click(),selectButton):null}function ClickOnChannelButton(){var buttonChannel=GetElementByTagAndAttributeFromDocument('ng-click','a','showPeerInfo()');return null!=buttonChannel?(buttonChannel.click(),buttonChannel):null}function GetElementByTagAndAttributeFromDocument(attribute,tag,attributeVal){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;for(var matchingElements=[],allElements=document.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndClassFromDocument(tag,classValue){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;for(var matchingElements=[],allElements=document.getElementsByClassName(classValue),i=0;i<allElements.length;i++){var tagUpper=tag.toUpperCase();if(allElements[i].tagName==tagUpper){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function ClickOnUserContainerFromElement(attribute,tag,classValue,attributeVal,element,tag2,username){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;if(IsEmpty(attribute))return null;if(IsEmpty(attributeVal))return null;if(null==element)return null;if(IsEmpty(tag2))return null;if(IsEmpty(username))return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){if(allElements[i].className==classValue&&allElements[i].getAttribute(attribute)==attributeVal)for(var allElementsSpan=allElements[i].getElementsByTagName(tag2),j=0;j<allElementsSpan.length;j++)if(allElementsSpan[j].innerText==username){matchingElements.push(allElements[i]);break}if(matchingElements.length>0)break}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndAttributeFromElement(attribute,tag,attributeVal,type,element){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;if(IsEmpty(type))return null;if(null==element)return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal&&allElements[i].type==type){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function IsEmpty(str){return!str||0===str.length}InviteUser('" + nameUser + "');";
            //return @"function Delay(ms){return new Promise((function(resolve,reject){setTimeout(resolve,ms)}))}async function InviteUser(nameUser){if(IsEmpty(nameUser))return'Пустое имя пользователя';var resultChannelDiv=null,resultButtonInvite=null,resultChannelButton=null,resultContactslDiv=GetContactslDiv();return null!=resultContactslDiv?await SetUser(nameUser,resultContactslDiv):null!=(resultChannelDiv=GetChannelDiv())?null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)):null==(resultChannelButton=ClickOnChannelButton())?'Ошибка при поиске кнопки чата':(await Delay(300),null==(resultChannelDiv=GetChannelDiv())?'Ошибка при поиске контейнера чата':null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)))}async function SetUser(nameUser,resultContactslDiv){var resultSearchInput=GetSearchInput(resultContactslDiv);if(null==resultSearchInput)return'Ошибка при поиске контейнера поиска';for(var i=0;i<nameUser.length;i++)resultSearchInput.value=resultSearchInput.value+nameUser[i],resultSearchInput.dispatchEvent(new Event('change')),await Delay(250);for(var count=0;;){var resultButtonClickUser=ClickOnButtonUser(resultContactslDiv,nameUser);if(5==count||null!=resultButtonClickUser)break;null==resultButtonClickUser&&(count+=1,await Delay(1e3))}if(null==resultButtonClickUser)return resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),'Пользователь не найден';await Delay(300);var resultClickSelectedUser=GetButtonSelectedUser(resultContactslDiv);return resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),null==resultClickSelectedUser?'Кнопка подтверждения инвайта не найдена':'Пользователь успешно добавлен'}function ClickOnButtonInvite(){var buttonInvite=GetElementByTagAndAttributeFromDocument('ng-click','a','inviteToChannel()');return null!=buttonInvite?(buttonInvite.click(),buttonInvite):null}function GetChannelDiv(){var channelDiv=GetElementByTagAndClassFromDocument('div','chat_modal_wrap md_modal_wrap');return null!=channelDiv?channelDiv:null}function GetContactslDiv(){var сontactslDiv=GetElementByTagAndClassFromDocument('div','contacts_modal_wrap md_modal_wrap');return null!=сontactslDiv?сontactslDiv:null}function ClickOnButtonUser(element,userName){var buttonUser=ClickOnUserContainerFromElement('ng-click','a','contacts_modal_contact','contactSelect(contact.userID)',element,'span',userName);return null!=buttonUser?(buttonUser.click(),buttonUser):null}function GetSearchInput(element){var сontactslDiv=GetElementByTagAndAttributeFromElement('ng-model','input','search.query','search',element);return null!=сontactslDiv?сontactslDiv:null}function GetButtonSelectedUser(element){var selectButton=GetElementByTagAndAttributeFromElement('ng-click','button','submitSelected()','submit',element);return null!=selectButton?(selectButton.click(),selectButton):null}function ClickOnChannelButton(){var buttonChannel=GetElementByTagAndAttributeFromDocument('ng-click','a','showPeerInfo()');return null!=buttonChannel?(buttonChannel.click(),buttonChannel):null}function GetElementByTagAndAttributeFromDocument(attribute,tag,attributeVal){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;for(var matchingElements=[],allElements=document.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndClassFromDocument(tag,classValue){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;for(var matchingElements=[],allElements=document.getElementsByClassName(classValue),i=0;i<allElements.length;i++){var tagUpper=tag.toUpperCase();if(allElements[i].tagName==tagUpper){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function ClickOnUserContainerFromElement(attribute,tag,classValue,attributeVal,element,tag2,username){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;if(IsEmpty(attribute))return null;if(IsEmpty(attributeVal))return null;if(null==element)return null;if(IsEmpty(tag2))return null;if(IsEmpty(username))return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){if(allElements[i].className==classValue&&allElements[i].getAttribute(attribute)==attributeVal)for(var allElementsSpan=allElements[i].getElementsByTagName(tag2),j=0;j<allElementsSpan.length;j++)if(allElementsSpan[j].innerText==username){matchingElements.push(allElements[i]);break}if(matchingElements.length>0)break}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndAttributeFromElement(attribute,tag,attributeVal,type,element){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;if(IsEmpty(type))return null;if(null==element)return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal&&allElements[i].type==type){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function IsEmpty(str){return!str||0===str.length}InviteUser('" + nameUser + "');";
            //return @"function Delay(ms){return new Promise((function(resolve,reject){setTimeout(resolve,ms)}))}async function InviteUser(nameUser){if(IsEmpty(nameUser))return'Пустое имя пользователя';var resultChannelDiv=null,resultButtonInvite=null,resultChannelButton=null,resultContactslDiv=GetContactslDiv();return null!=resultContactslDiv?await SetUser(nameUser,resultContactslDiv):null!=(resultChannelDiv=GetChannelDiv())?null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)):null==(resultChannelButton=ClickOnChannelButton())?'Ошибка при поиске кнопки чата':(await Delay(300),null==(resultChannelDiv=GetChannelDiv())?'Ошибка при поиске контейнера чата':null==(resultButtonInvite=ClickOnButtonInvite())?'Ошибка при поиске кнопки инвайта пользователя':(await Delay(300),null==(resultContactslDiv=GetContactslDiv())?'Ошибка при поиске контейнера контактов':await SetUser(nameUser,resultContactslDiv)))}async function SetUser(nameUser,resultContactslDiv){var resultSearchInput=GetSearchInput(resultContactslDiv),resultClickSelectedUser;if(null==resultSearchInput)return'Ошибка при поиске контейнера поиска';for(var i=0;i<nameUser.length;i++)resultSearchInput.value=resultSearchInput.value+nameUser[i],resultSearchInput.dispatchEvent(new Event('change')),await Delay(250);for(var count=0;;){var resultButtonClickUser=ClickOnButtonUser(resultContactslDiv,nameUser);if(5==count||null!=resultButtonClickUser)break;null==resultButtonClickUser&&(count+=1,await Delay(1e3))}return null==resultButtonClickUser?(resultSearchInput.value='',resultSearchInput.dispatchEvent(new Event('change')),'Пользователь не найден'):(await Delay(300),null==GetButtonSelectedUser(resultContactslDiv)?'Кнопка подтверждения инвайта не найдена':'Пользователь успешно добавлен')}function ClickOnButtonInvite(){var buttonInvite=GetElementByTagAndAttributeFromDocument('ng-click','a','inviteToChannel()');return null!=buttonInvite?(buttonInvite.click(),buttonInvite):null}function GetChannelDiv(){var channelDiv=GetElementByTagAndClassFromDocument('div','chat_modal_wrap md_modal_wrap');return null!=channelDiv?channelDiv:null}function GetContactslDiv(){var сontactslDiv=GetElementByTagAndClassFromDocument('div','contacts_modal_wrap md_modal_wrap');return null!=сontactslDiv?сontactslDiv:null}function ClickOnButtonUser(element,userName){var buttonUser=ClickOnUserContainerFromElement('ng-click','a','contacts_modal_contact','contactSelect(contact.userID)',element,'span',userName);return null!=buttonUser?(buttonUser.click(),buttonUser):null}function GetSearchInput(element){var сontactslDiv=GetElementByTagAndAttributeFromElement('ng-model','input','search.query','search',element);return null!=сontactslDiv?сontactslDiv:null}function GetButtonSelectedUser(element){var selectButton=GetElementByTagAndAttributeFromElement('ng-click','button','submitSelected()','submit',element);return null!=selectButton?(selectButton.click(),selectButton):null}function ClickOnChannelButton(){var buttonChannel=GetElementByTagAndAttributeFromDocument('ng-click','a','showPeerInfo()');return null!=buttonChannel?(buttonChannel.click(),buttonChannel):null}function GetElementByTagAndAttributeFromDocument(attribute,tag,attributeVal){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;for(var matchingElements=[],allElements=document.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndClassFromDocument(tag,classValue){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;for(var matchingElements=[],allElements=document.getElementsByClassName(classValue),i=0;i<allElements.length;i++){var tagUpper=tag.toUpperCase();if(allElements[i].tagName==tagUpper){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function ClickOnUserContainerFromElement(attribute,tag,classValue,attributeVal,element,tag2,username){if(IsEmpty(tag))return null;if(IsEmpty(classValue))return null;if(IsEmpty(attribute))return null;if(IsEmpty(attributeVal))return null;if(null==element)return null;if(IsEmpty(tag2))return null;if(IsEmpty(username))return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){if(allElements[i].className==classValue&&allElements[i].getAttribute(attribute)==attributeVal)for(var allElementsSpan=allElements[i].getElementsByTagName(tag2),j=0;j<allElementsSpan.length;j++)if(allElementsSpan[j].innerText==username){matchingElements.push(allElements[i]);break}if(matchingElements.length>0)break}return matchingElements.length>0?matchingElements[0]:null}function GetElementByTagAndAttributeFromElement(attribute,tag,attributeVal,type,element){if(IsEmpty(attribute))return null;if(IsEmpty(tag))return null;if(IsEmpty(attributeVal))return null;if(IsEmpty(type))return null;if(null==element)return null;for(var matchingElements=[],allElements=element.getElementsByTagName(tag),i=0;i<allElements.length;i++){var attributeValue;if(allElements[i].getAttribute(attribute)==attributeVal&&allElements[i].type==type){matchingElements.push(allElements[i]);break}}return matchingElements.length>0?matchingElements[0]:null}function IsEmpty(str){return!str||0===str.length}InviteUser('" + nameUser + "');";
        }

        public async Task StartInvite(List<String> Groups, List<String> UserNames, int Delay)
        {
            LogViewer.WriteLog("Инвайтер - Проверка параметров -");

            if (Delay < 1000 || Delay > 5000000)
            {
                IsWork = false;
                throw new Exception("Указаны некорректные параметры задержки при отправке");
            }

            if (Groups != null && Groups.Count() <= 0)
            {
                IsWork = false;
                throw new Exception("Необходимо указать не менее одной группы");
            }

            if (UserNames != null && UserNames.Count() <= 0)
            {
                IsWork = false;
                throw new Exception("Необходимо указать не менее одного пользователя");
            }

            if (BrowserViewer.GetCurrentUrl() == "https://web.telegram.org/#/login")
            {
                IsWork = false;
                throw new Exception("Необходимо авторизоваться в браузере");
            }

            StopWork();

            LogViewer.WriteLog("Инвайтер - В работе -");

            for (int g = 0; g < Groups.Count; g++)
            {
                BrowserViewer.browser_form.chromeBrowser.Load($"https://web.telegram.org/#/im?p={Groups[g]}");

                int counter = 0;

                while(true)
                {
                    StopWork();

                    if (BrowserViewer.browser_form.chromeBrowser.IsLoading)
                    {
                        if(counter == 10)
                        {
                            throw new Exception("В течении 10 секунд не был получен ответ об удачной загрузке страницы в браузере");
                        }

                        counter++;
                        await Task.Delay(1000);
                        continue;
                    }

                    break;
                }

                StopWork();

                for (int i = 0; i < UserNames.Count; i++)
                {
                    String script = GetScript(UserNames[i]);

                    if (BrowserViewer.browser_form.chromeBrowser.CanExecuteJavascriptInMainFrame && !String.IsNullOrWhiteSpace(script))
                    {
                        JavascriptResponse javascriptResponse = await BrowserViewer.browser_form.chromeBrowser.EvaluateScriptAsPromiseAsync(script);

                        if(javascriptResponse.Success)
                        {
                            LogViewer.WriteLog($"Инъекция скрипта - ({i + 1}) '{UserNames[i]}' - Успешно -");
                        }
                        else
                        {
                            LogViewer.WriteLog($"Инъекция скрипта - ({i + 1}) '{UserNames[i]}' - Неудачно -");
                        }
                    }

                    await Task.Delay(GetDelay(Delay, UserNames[i].Length));
                    StopWork();
                }
            }
        }

        private int GetDelay(int Delay, int countSymbol)
        {
            int clickChannelButton = 300;
            int clickInviteButton = 300;
            int searchInputChar = countSymbol * 250;
            int searchWorking = 5 * 1000;
            int clickSearchUser = 300;

            int TempDelay = Delay - (clickChannelButton + clickInviteButton + searchInputChar + searchWorking + clickSearchUser);

            if(TempDelay < 0)
            {
                Delay += Math.Abs(TempDelay);
            }

            return Delay;
        }
    }
}
